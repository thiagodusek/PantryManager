package com.pantrymanager.presentation.viewmodel

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.pantrymanager.domain.entity.Brand
import com.pantrymanager.domain.usecase.brand.AddBrandUseCase
import com.pantrymanager.domain.usecase.brand.GetAllBrandsUseCase
import com.pantrymanager.domain.usecase.brand.UpdateBrandUseCase
import com.pantrymanager.domain.usecase.brand.DeleteBrandUseCase
import com.pantrymanager.domain.usecase.brand.PopulateBrandsFromOpenAIUseCase
import com.pantrymanager.domain.usecase.brand.RemoveDuplicateBrandsUseCase
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch
import javax.inject.Inject

data class BrandState(
    val name: String = "",
    val brands: List<Brand> = emptyList(),
    val selectedBrands: Set<Long> = emptySet(),
    val isSelectionMode: Boolean = false,
    val isLoading: Boolean = false,
    val errorMessage: String? = null,
    val isSuccess: Boolean = false,
    val nameError: String? = null,
    val editingBrand: Brand? = null,
    val showEditDialog: Boolean = false,
    val showDeleteDialog: Boolean = false,
    val brandToDelete: Brand? = null,
    val showMultiDeleteDialog: Boolean = false
)

@HiltViewModel
class BrandViewModel @Inject constructor(
    private val addBrandUseCase: AddBrandUseCase,
    private val getAllBrandsUseCase: GetAllBrandsUseCase,
    private val updateBrandUseCase: UpdateBrandUseCase,
    private val deleteBrandUseCase: DeleteBrandUseCase,
    private val populateBrandsFromOpenAIUseCase: PopulateBrandsFromOpenAIUseCase,
    private val removeDuplicateBrandsUseCase: RemoveDuplicateBrandsUseCase
) : ViewModel() {

    private val _state = MutableStateFlow(BrandState())
    val state: StateFlow<BrandState> = _state.asStateFlow()

    init {
        loadBrands()
    }

    fun onNameChanged(name: String) {
        _state.value = _state.value.copy(
            name = name,
            nameError = null
        )
    }

    fun addBrand() {
        if (!validateBrand()) return

        viewModelScope.launch {
            _state.value = _state.value.copy(isLoading = true, errorMessage = null)
            
            try {
                println("DEBUG - Adicionando marca: ${_state.value.name}")
                
                val brand = Brand(
                    id = 0, // Will be auto-generated by Firebase
                    name = _state.value.name.trim()
                )
                
                val result = addBrandUseCase(brand)
                if (result.isSuccess) {
                    println("DEBUG - Marca adicionada com sucesso, recarregando lista...")
                    
                    // Limpa o formulário e loading primeiro
                    _state.value = _state.value.copy(
                        name = "",
                        isLoading = false,
                        isSuccess = true,
                        errorMessage = "Marca cadastrada com sucesso!"
                    )
                    
                    // Depois recarrega a lista
                    loadBrands()
                } else {
                    println("DEBUG - Erro ao adicionar marca: ${result.exceptionOrNull()?.message}")
                    _state.value = _state.value.copy(
                        isLoading = false,
                        errorMessage = "Erro ao cadastrar marca: ${result.exceptionOrNull()?.message}"
                    )
                }
            } catch (e: Exception) {
                println("DEBUG - Exceção ao adicionar marca: ${e.message}")
                _state.value = _state.value.copy(
                    isLoading = false,
                    errorMessage = e.message ?: "Erro desconhecido"
                )
            }
        }
    }

    fun startEditBrand(brand: Brand) {
        _state.value = _state.value.copy(
            editingBrand = brand,
            name = brand.name,
            showEditDialog = true,
            nameError = null
        )
    }

    fun updateBrand() {
        val editingBrand = _state.value.editingBrand ?: return
        if (!validateBrand(editingBrand.id)) return

        viewModelScope.launch {
            _state.value = _state.value.copy(isLoading = true, errorMessage = null)
            
            try {
                println("DEBUG - Atualizando marca: ${editingBrand.name} -> ${_state.value.name}")
                
                val updatedBrand = editingBrand.copy(
                    name = _state.value.name.trim()
                )
                
                updateBrandUseCase(updatedBrand)
                
                // Limpa o dialog e form primeiro
                _state.value = _state.value.copy(
                    isLoading = false,
                    isSuccess = true,
                    showEditDialog = false,
                    editingBrand = null,
                    errorMessage = "Marca atualizada com sucesso!"
                )
                clearForm()
                
                // Depois recarrega a lista
                loadBrands()
                
                println("DEBUG - Marca atualizada com sucesso")
            } catch (e: Exception) {
                println("DEBUG - Erro ao atualizar marca: ${e.message}")
                _state.value = _state.value.copy(
                    isLoading = false,
                    errorMessage = e.message ?: "Erro ao atualizar marca"
                )
            }
        }
    }

    fun confirmDeleteBrand(brand: Brand) {
        _state.value = _state.value.copy(
            brandToDelete = brand,
            showDeleteDialog = true
        )
    }

    fun deleteBrand() {
        val brandToDelete = _state.value.brandToDelete ?: return

        viewModelScope.launch {
            _state.value = _state.value.copy(isLoading = true, errorMessage = null)
            
            try {
                println("DEBUG - Iniciando exclusão da marca: ${brandToDelete.name} (ID: ${brandToDelete.id})")
                
                val result = deleteBrandUseCase(brandToDelete)
                if (result.isSuccess) {
                    println("DEBUG - Marca excluída com sucesso, recarregando lista...")
                    
                    // Primeiro limpa o dialog e loading
                    _state.value = _state.value.copy(
                        showDeleteDialog = false,
                        brandToDelete = null,
                        isLoading = false
                    )
                    
                    // Depois recarrega a lista
                    loadBrands()
                    
                    // Por fim mostra a mensagem de sucesso
                    _state.value = _state.value.copy(
                        isSuccess = true,
                        errorMessage = "Marca excluída com sucesso!"
                    )
                } else {
                    println("DEBUG - Erro ao excluir marca: ${result.exceptionOrNull()?.message}")
                    _state.value = _state.value.copy(
                        isLoading = false,
                        showDeleteDialog = false,
                        brandToDelete = null,
                        errorMessage = "Erro ao excluir marca: ${result.exceptionOrNull()?.message}"
                    )
                }
            } catch (e: Exception) {
                println("DEBUG - Exceção ao excluir marca: ${e.message}")
                _state.value = _state.value.copy(
                    isLoading = false,
                    showDeleteDialog = false,
                    brandToDelete = null,
                    errorMessage = e.message ?: "Erro ao excluir marca"
                )
            }
        }
    }

    fun cancelEdit() {
        _state.value = _state.value.copy(
            showEditDialog = false,
            editingBrand = null
        )
        clearForm()
    }

    fun cancelDelete() {
        _state.value = _state.value.copy(
            showDeleteDialog = false,
            brandToDelete = null
        )
    }

    fun clearSuccess() {
        _state.value = _state.value.copy(isSuccess = false)
    }

    fun clearError() {
        _state.value = _state.value.copy(errorMessage = null)
    }

    // Multiple selection functions
    fun toggleBrandSelection(brandId: Long) {
        val currentSelection = _state.value.selectedBrands
        val newSelection = if (currentSelection.contains(brandId)) {
            currentSelection - brandId
        } else {
            currentSelection + brandId
        }
        
        _state.value = _state.value.copy(
            selectedBrands = newSelection,
            isSelectionMode = newSelection.isNotEmpty()
        )
    }

    fun selectAllBrands() {
        _state.value = _state.value.copy(
            selectedBrands = _state.value.brands.map { it.id }.toSet(),
            isSelectionMode = true
        )
    }

    fun clearSelection() {
        _state.value = _state.value.copy(
            selectedBrands = emptySet(),
            isSelectionMode = false
        )
    }

    fun confirmMultipleDelete() {
        _state.value = _state.value.copy(showMultiDeleteDialog = true)
    }

    fun cancelMultipleDelete() {
        _state.value = _state.value.copy(showMultiDeleteDialog = false)
    }

    fun deleteSelectedBrands() {
        val selectedIds = _state.value.selectedBrands
        if (selectedIds.isEmpty()) return

        viewModelScope.launch {
            _state.value = _state.value.copy(isLoading = true, errorMessage = null)
            
            try {
                // Exclusão real das marcas
                selectedIds.forEach { brandId ->
                    deleteBrandUseCase(brandId)
                }
                loadBrands()
                
                _state.value = _state.value.copy(
                    isLoading = false,
                    isSuccess = true,
                    selectedBrands = emptySet(),
                    isSelectionMode = false,
                    showMultiDeleteDialog = false,
                    errorMessage = "${selectedIds.size} marca(s) excluída(s) com sucesso!"
                )
            } catch (e: Exception) {
                _state.value = _state.value.copy(
                    isLoading = false,
                    errorMessage = e.message ?: "Erro ao excluir marcas"
                )
            }
        }
    }

    private fun validateBrand(excludeId: Long = -1): Boolean {
        val trimmedName = _state.value.name.trim()
        
        if (trimmedName.isBlank()) {
            _state.value = _state.value.copy(nameError = "Nome da marca é obrigatório")
            return false
        }

        // Check if brand already exists (excluding current brand when editing)
        val brandExists = _state.value.brands.any { 
            it.name.equals(trimmedName, ignoreCase = true) && it.id != excludeId
        }
        
        if (brandExists) {
            _state.value = _state.value.copy(nameError = "Esta marca já existe")
            return false
        }

        return true
    }

    private fun clearForm() {
        _state.value = _state.value.copy(
            name = "",
            nameError = null
        )
    }

    private fun loadBrands() {
        viewModelScope.launch {
            try {
                println("DEBUG - Carregando marcas...")
                _state.value = _state.value.copy(isLoading = true)
                
                val brands = getAllBrandsUseCase()
                println("DEBUG - Marcas carregadas: ${brands.size} marcas encontradas")
                
                _state.value = _state.value.copy(
                    brands = brands,
                    isLoading = false,
                    errorMessage = null
                )
            } catch (e: Exception) {
                println("DEBUG - Erro ao carregar marcas: ${e.message}")
                _state.value = _state.value.copy(
                    brands = emptyList(),
                    isLoading = false,
                    errorMessage = "Erro ao carregar marcas: ${e.message}"
                )
            }
        }
    }

    /**
     * Busca marcas automaticamente via ChatGPT e cadastra as novas
     */
    fun populateBrandsFromChatGPT() {
        viewModelScope.launch {
            _state.value = _state.value.copy(isLoading = true, errorMessage = null)
            
            try {
                val result = populateBrandsFromOpenAIUseCase()
                
                if (result.isSuccess) {
                    val addedCount = result.getOrThrow()
                    loadBrands() // Recarregar lista
                    _state.value = _state.value.copy(
                        isLoading = false,
                        errorMessage = "✅ $addedCount novas marcas encontradas e cadastradas via ChatGPT!"
                    )
                } else {
                    _state.value = _state.value.copy(
                        isLoading = false,
                        errorMessage = "Erro ao buscar marcas no ChatGPT: ${result.exceptionOrNull()?.message}"
                    )
                }
            } catch (e: Exception) {
                _state.value = _state.value.copy(
                    isLoading = false,
                    errorMessage = "Erro ao buscar marcas: ${e.message}"
                )
            }
        }
    }

    /**
     * Remove marcas duplicadas do banco de dados
     */
    fun removeDuplicateBrands() {
        viewModelScope.launch {
            _state.value = _state.value.copy(isLoading = true, errorMessage = null)
            
            try {
                val result = removeDuplicateBrandsUseCase()
                
                if (result.isSuccess) {
                    val removedCount = result.getOrThrow()
                    loadBrands() // Recarregar lista
                    _state.value = _state.value.copy(
                        isLoading = false,
                        errorMessage = if (removedCount > 0) {
                            "✅ $removedCount marcas duplicadas foram removidas!"
                        } else {
                            "✅ Nenhuma marca duplicada encontrada!"
                        }
                    )
                } else {
                    _state.value = _state.value.copy(
                        isLoading = false,
                        errorMessage = "Erro ao remover duplicatas: ${result.exceptionOrNull()?.message}"
                    )
                }
            } catch (e: Exception) {
                _state.value = _state.value.copy(
                    isLoading = false,
                    errorMessage = "Erro ao remover duplicatas: ${e.message}"
                )
            }
        }
    }
}
